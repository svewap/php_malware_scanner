<?php

$path = ".";

$directory = new \RecursiveDirectoryIterator($path, \FilesystemIterator::FOLLOW_SYMLINKS);
$filter = new MyRecursiveFilterIterator($directory);
$iterator = new \RecursiveIteratorIterator($filter);

class MyRecursiveFilterIterator extends \RecursiveFilterIterator {

  public function accept() {
    $filename = $this->current()->getFilename();
    if ($this->current()->isFile()) {
    if (substr($filename,-4) == ".php" && $filename != 'scan.php') {
        return true;
    }
    return false;
    }
    return true;
    
    if ($filename == '.' || $filename == '..' || $filename == 'scan.php') {
      return FALSE;
    }
    return true;
  }

}


$files = array();
foreach ($iterator as $info) {
    
    $contents = file_get_contents($info->getPathname());

    /* TODO: Mit Regex arbeiten
    $pattern = '/chr\(102|\x34|\x65|\x66|\x363a/mi';
    if (preg_match($pattern, $contents)) {
        $files[] = $info->getPathname();
    }*/
    if (strpos($contents,"chr(102") || strpos($contents,"\\x34") || strpos($contents,"\\x66") || strpos($contents,"\\x363a")) {
        $files[] = $info->getPathname();
    }
    
}

echo "Have found suspicious code in the following files:\n";
print_r($files);

